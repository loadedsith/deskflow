# XI2 Smooth Scrolling Implementation Plan

## Goal
Implement XI2 smooth scrolling support in deskflow/deskflow to enable modern touchpad scrolling behavior in Synergy 3.

## Context
- **Upstream repo**: deskflow/deskflow (Synergy 3 uses this as its engine)
- **Current state**: Uses Button4/5 wheel events (legacy PS/2 style)
- **Target**: XI2 valuator-based smooth scrolling
- **Important**: PRs must follow contributing guidelines or will be closed immediately

---

## Phase 1: Setup & Baseline (Week 1)

### 1.1 Fork & Clone
- [x] Fork deskflow/deskflow on GitHub
- [x] Clone fork locally
- [x] Set up upstream remote tracking

### 1.2 Build Environment
- [x] Read Build Guide / Hacking Guide in wiki
- [x] Install dependencies per guide
  - Installed: cmake 4.2.0, Qt 6.9.3, OpenSSL 3.6.0
- [x] Build deskflow-core successfully
- [x] Build deskflow-gui successfully
- [x] Verify builds pass tests
  - Note: Some unit tests failed (I18NTests, IKeyStateTests, OSXKeyStateTests) but binaries built successfully
  - Fixed pthread linking issue for macOS (pthread is automatic on macOS, no explicit linking needed)

### 1.3 Test Setup
- [x] Set up two machines on LAN:
  - Machine A (Server): 192.168.1.137/192.168.1.206 - gheath-ltmxwm4.internal.salesforce.com (macOS)
  - Machine B (Client): 192.168.1.180 - pop-os (Linux/Pop!_OS)
- [x] Network connectivity established:
  - âœ… TLS disabled: Connections work reliably
  - âŒ TLS enabled: Connections fail (TLS handshake issue)
  - **Configuration**: Using `tlsEnabled=false` for testing
  - Server config: `deskflow-server.conf` with screens and links configured
  - Key remapping: Synergy-style config applied (super/ctrl swap for Linux client)
- [x] Establish baseline behavior:
  - [x] Test pointer movement (verify working)
  - [x] Test current scrolling (Button4/5 events)
  - [x] Document current scroll behavior (choppy, step-based)
    - **Observed**: Scrolling 3 lines at a time using Button4/5
    - **Expected**: Smooth scrolling with fractional deltas via XI2 valuators
  - [ ] Test with various input devices:
    - [ ] Traditional mouse with wheel
    - [ ] Touchpad
    - [ ] Trackball
- [x] Document "baseline broken" state for reference
  - **Status**: Button4/5 works but choppy (3 lines per click)

---

## Phase 2: Code Investigation (Week 1-2)

### 2.1 Locate X11 Input Backend
- [x] Find X11 input handling code
  - **Location**: `deskflow/src/lib/platform/XWindowsScreen.cpp`
  - **Key class**: `XWindowsScreen` (implements `PlatformScreen`)
- [x] Identify pointer motion handling location
  - **XI2 motion**: Lines 1174-1198 (`XI_RawMotion` events)
  - **Legacy motion**: `onMouseMove()` method (line 1480+)
- [x] Locate Button4/5 wheel event handlers
  - **Location**: `XWindowsScreen::onMouseRelease()` lines 1470-1476
  - **Current implementation**: Hardcoded Â±120 deltas
  - **Code**: `WheelInfo::alloc(0, 120)` for Button4, `WheelInfo::alloc(0, -120)` for Button5
- [x] Map code flow: input â†’ internal messages
  - **Input**: X11 ButtonRelease events (button 4/5)
  - **Handler**: `onMouseRelease()` â†’ `sendEvent(PrimaryScreenWheel, WheelInfo::alloc(...))`
  - **Internal**: `WheelInfo` struct with `int32_t m_xDelta, m_yDelta` (multiples of 120)

### 2.2 Understand XI2 Implementation
- [x] Find existing XI2 motion handling code
  - **Location**: `XWindowsScreen.cpp` lines 1174-1198
  - **Detection**: `detectXI2()` (line 1945) checks for XInputExtension
  - **Subscription**: `selectXIRawMotion()` (line 1953) subscribes to `XI_RawMotion` and `XI_RawKeyRelease`
- [x] Understand current XI2 subscription setup
  - Uses `XISelectEvents()` with `XIAllMasterDevices`
  - Currently only subscribes to `XI_RawMotion` and `XI_RawKeyRelease`
  - **Missing**: Scroll valuator events (need to add `XI_RawButton` or scroll valuators)
- [x] Review valuator handling patterns
  - **Reference**: `EiScreen::onPointerScrollEvent()` (lines 659-706) shows perfect pattern:
    - Uses fractional deltas (`double dx, dy`)
    - Accumulates remainders using `modf()` for sub-pixel precision
    - Converts to multiples of 120 (standard wheel click)
- [x] Identify where scroll valuators would fit
  - **Need to add**: Scroll valuator subscription in `selectXIRawMotion()` or new method
  - **Need to add**: Scroll valuator event handler in `handleSystemEvent()` (around line 1174)
  - **Valuator IDs**: Typically `SCROLL_X` (6) and `SCROLL_Y` (7) in XI2

### 2.3 Understand Internal Scroll Messages
- [x] Find Deskflow's internal scroll message format
  - **Class**: `IPrimaryScreen::WheelInfo` (`deskflow/src/lib/deskflow/IPrimaryScreen.h` lines 51-59)
  - **Fields**: `int32_t m_xDelta, m_yDelta` (multiples of 120)
  - **Allocation**: `WheelInfo::alloc(xDelta, yDelta)` static method
- [x] Understand current delta representation (likely integer steps)
  - **Current**: Integer multiples of 120 (standard wheel click)
  - **Button4**: `+120` (forward/away from user)
  - **Button5**: `-120` (backward/toward user)
  - **No fractional support** in current X11 implementation
- [x] Determine if fractional deltas are supported
  - **WheelInfo**: Only supports `int32_t`, so no fractional deltas directly
  - **Solution**: Use remainder accumulator pattern (like `EiScreen`) to accumulate fractional parts
  - **Conversion**: Convert fractional scroll deltas to multiples of 120, accumulate remainders
- [x] Map Button4/5 â†’ internal message conversion
  - **Flow**: `XButtonEvent` (button 4/5) â†’ `onMouseRelease()` â†’ `WheelInfo::alloc(0, Â±120)` â†’ `PrimaryScreenWheel` event
  - **Note**: X-axis scrolling not supported (see `// XXX -- support x-axis scrolling` comments)

---

## Phase 3: Implementation (Week 2-3)

### 3.1 XI2 Scroll Subscription
- [x] Extend XI2 setup to subscribe to scroll valuators
  - **Implementation**: Added `detectScrollValuators()` method
  - **Detection**: Queries XI2 devices to find scroll valuators (typically 6 and 7)
  - **Fallback**: Uses standard valuator IDs if labels not available
- [x] Add valuator mask for scroll axes
  - **Implementation**: Scroll valuators detected and stored in `m_scrollValuatorX` and `m_scrollValuatorY`
  - **Event subscription**: Already subscribed via `XI_RawMotion` events
- [x] Handle valuator device changes
  - **Note**: Currently detects at initialization; device hotplugging not yet handled

### 3.2 Scroll Event Handling
- [x] Implement XI2 scroll valuator event handler
  - **Method**: `handleXIRawMotionScroll()` processes scroll valuator deltas from `XI_RawMotion` events
  - **Location**: Called from `handleSystemEvent()` when `XI_RawMotion` detected
- [x] Extract delta values from valuator events
  - **Implementation**: Extracts scroll valuator deltas from `XIRawEvent->valuators.values` array
  - **Mask checking**: Uses `XIMaskIsSet()` to identify which valuators changed
- [x] Convert valuator deltas to Deskflow scroll messages
  - **Conversion**: Uses 10 pixels = 1 wheel click ratio (120 units)
  - **Format**: Converts to `WheelInfo::alloc(xDelta, yDelta)` format
- [x] Support fractional deltas (not just +1/-1 steps)
  - **Pattern**: Uses remainder accumulator (`ScrollRemainder` struct) like `EiScreen`
  - **Implementation**: Uses `modf()` to accumulate fractional parts between events

### 3.3 Feature Flagging
- [ ] Add config option: `experimental_xi2_smooth_scrolling` (or similar)
- [ ] Add environment variable fallback: `DESKFLOW_XI2_SCROLL`
- [ ] Make XI2 scroll opt-in initially (default: false)
- [ ] Ensure Button4/5 fallback still works when disabled

### 3.4 Code Quality
- [ ] Follow Code Style guide from wiki
- [ ] Follow build rules from wiki
- [ ] Add appropriate comments
- [ ] Ensure no memory leaks
- [ ] Handle error cases gracefully

---

## Phase 4: Testing (Week 3-4)

### 4.1 Platform Testing
- [ ] Test on X11 (primary target)
- [ ] Test on Wayland (if applicable)
- [ ] Verify no regressions on either platform

### 4.2 Device Testing
- [ ] Test with various mice:
  - [ ] Traditional wheel mouse
  - [ ] High-resolution scroll wheel mouse
- [ ] Test with various touchpads:
  - [ ] Apple Magic Trackpad
  - [ ] Linux touchpad (libinput)
  - [ ] Windows Precision Touchpad (if applicable)
- [ ] Test with trackball
- [ ] Document device-specific behavior

### 4.3 Application Testing
- [ ] Test browsers (notoriously picky):
  - [ ] Chrome/Chromium
  - [ ] Firefox
  - [ ] Safari (if applicable)
- [ ] Test text editors:
  - [ ] VS Code
  - [ ] Vim/Neovim
  - [ ] Emacs
- [ ] Test terminal applications
- [ ] Test GUI applications with custom scroll handling

### 4.4 Edge Cases
- [ ] Test rapid scrolling
- [ ] Test slow/precise scrolling
- [ ] Test horizontal scrolling (if supported)
- [ ] Test with feature flag disabled (fallback behavior)
- [ ] Test device hotplugging
- [ ] Test multi-device scenarios

---

## Phase 5: Documentation & PR Prep (Week 4)

### 5.1 Code Documentation
- [ ] Ensure code is well-commented
- [ ] Document config options
- [ ] Document environment variables
- [ ] Add code comments explaining XI2 valuator handling

### 5.2 Commit History
- [ ] Create clean branch: `feature/xi2-smooth-scrolling`
- [ ] Organize commits logically:
  - [ ] Setup/refactor commits (if needed)
  - [ ] Feature implementation commits
  - [ ] Test/validation commits
- [ ] Write clear commit messages (~40 chars, per your preference)
- [ ] Ensure each commit is coherent and builds

### 5.3 PR Description
- [ ] **Problem**: Document current choppy scroll, Button4/5 limitations
- [ ] **Solution**: Explain XI2 valuator scroll implementation
- [ ] **Changes**: List files changed, key functions added/modified
- [ ] **Testing**: Document platforms tested, devices tested, apps tested
- [ ] **Risks**: Note any edge cases or potential regressions
- [ ] **Feature Flag**: Explain opt-in nature, migration path

### 5.4 Pre-PR Validation
- [ ] Run full test suite
- [ ] Verify builds on clean checkout
- [ ] Check code style compliance
- [ ] Review against Contributing guidelines
- [ ] Consider opening GitHub Discussion first (optional)
- [ ] Consider Matrix/IRC discussion for design feedback (optional)

---

## Phase 6: PR Submission (Week 4-5)

### 6.1 Open PR
- [ ] Target: deskflow/deskflow â†’ main (or branch specified in CONTRIBUTING)
- [ ] Include comprehensive PR description
- [ ] Link to any related issues/discussions
- [ ] Tag appropriately

### 6.2 Respond to Feedback
- [ ] Address code review comments promptly
- [ ] Make requested changes
- [ ] Update tests if needed
- [ ] Update documentation if needed

### 6.3 Follow-up
- [ ] Monitor PR for maintainer feedback
- [ ] Be responsive to questions
- [ ] If merged, celebrate! ðŸŽ‰
- [ ] If not merged, learn from feedback and iterate

---

## Success Criteria

- [ ] XI2 smooth scrolling works on X11
- [ ] Feature is opt-in via config/env var
- [ ] No regressions in existing scroll behavior
- [ ] Works with various input devices
- [ ] PR accepted upstream
- [ ] Code follows project style guidelines

---

## Notes

- **Upstream first**: All work happens in deskflow/deskflow, not Synergy
- **Quality matters**: "AI-trash PRs will be closed immediately" - follow guidelines strictly
- **Incremental**: Feature flag allows safe, gradual rollout
- **Testing is critical**: Various devices and apps must work correctly

---

## Timeline Estimate

- **Phase 1**: 3-5 days
- **Phase 2**: 3-5 days
- **Phase 3**: 5-7 days
- **Phase 4**: 5-7 days
- **Phase 5**: 2-3 days
- **Phase 6**: Variable (depends on maintainer response)

**Total**: ~4-5 weeks for initial implementation + PR cycle

## Test Machine Setup (Phase 1.3)

**Machine One (Server):**
- IPs: 192.168.1.137 / 192.168.1.206
- Hostname: gheath-ltmxwm4.internal.salesforce.com
- Role: deskflow-server

**Machine Two (Client - Current):**
- IP: 192.168.1.180
- Hostname: pop-os
- Role: deskflow-client
- Status: Build complete, ready for testing

